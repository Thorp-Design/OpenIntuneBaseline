name: Check Upstream OIB Updates

on:
  schedule:
    - cron: '0 6 * * 0'  # Weekly Sunday 6am UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/SkipToTheEndpoint/OpenIntuneBaseline.git || true
          git fetch upstream main

      - name: Check for differences
        id: diff
        run: |
          BEHIND=$(git rev-list HEAD..upstream/main --count)
          UPSTREAM_SHA=$(git rev-parse --short upstream/main)
          CURRENT_SHA=$(git rev-parse --short HEAD)

          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
          echo "has_updates=$([[ $BEHIND -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT

          # Save details for issue
          if [ "$BEHIND" -gt 0 ]; then
            git diff --name-only HEAD upstream/main -- '*.json' > /tmp/changed_policies.txt
            git log --oneline HEAD..upstream/main > /tmp/commits.txt

            # Get changelogs
            git show upstream/main:WINDOWS/CHANGELOG.md 2>/dev/null | head -100 > /tmp/win_changelog.md || echo "No changelog" > /tmp/win_changelog.md
            git show upstream/main:MACOS/CHANGELOG.md 2>/dev/null | head -50 > /tmp/mac_changelog.md || echo "No changelog" > /tmp/mac_changelog.md
          fi

      - name: Create or update issue
        if: steps.diff.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let changedPolicies = '', commits = '', winChangelog = '', macChangelog = '';
            try {
              changedPolicies = fs.readFileSync('/tmp/changed_policies.txt', 'utf8');
              commits = fs.readFileSync('/tmp/commits.txt', 'utf8');
              winChangelog = fs.readFileSync('/tmp/win_changelog.md', 'utf8');
              macChangelog = fs.readFileSync('/tmp/mac_changelog.md', 'utf8');
            } catch (e) {}

            const body = `# Upstream OIB Updates Available

            This fork is **${{ steps.diff.outputs.behind }}** commits behind upstream.

            | | Commit |
            |---|--------|
            | **Current** | \`${{ steps.diff.outputs.current_sha }}\` |
            | **Upstream** | \`${{ steps.diff.outputs.upstream_sha }}\` |

            ## New Commits

            \`\`\`
            ${commits}
            \`\`\`

            ## Changed Policies

            \`\`\`
            ${changedPolicies}
            \`\`\`

            ## Windows Changelog

            ${winChangelog.split('\n').slice(0, 50).join('\n')}

            ## macOS Changelog

            ${macChangelog.split('\n').slice(0, 30).join('\n')}

            ## To Sync

            **Option 1: GitHub UI**
            - Click "Sync fork" button on the repo page

            **Option 2: Command line**
            \`\`\`bash
            git fetch upstream main
            git merge upstream/main
            git push origin main
            \`\`\`

            **Then update intune-policies submodule:**
            \`\`\`bash
            cd path/to/intune-policies
            cd OIB && git pull origin main && cd ..
            git add OIB
            git commit -m "Update OIB submodule"
            git push
            \`\`\`

            ---
            *Auto-generated weekly*
            `;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            const existingIssue = issues.data.find(i => i.title.includes('Upstream OIB Updates'));

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Upstream OIB Updates Available',
                body: body,
                labels: ['upstream-sync', 'automated']
              });
              console.log('Created new issue');
            }

      - name: Close issue if in sync
        if: steps.diff.outputs.has_updates == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            for (const issue of issues.data) {
              if (issue.title.includes('Upstream OIB Updates')) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed'
                });
                console.log(`Closed issue #${issue.number} - now in sync`);
              }
            }
